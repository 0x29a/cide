---
# Playbook for setting up everything.

- name: Set up CIDE.
  hosts: init
  vars_files:
    - .vars.private.yml
  tasks:
    - name: Creating a user named {{ username }} on the specified web server.
      user: 
        name: "{{ username }}"
        password: "{{ user_password | password_hash('sha512') }}"
        state: present
        shell: /bin/bash
        groups: sudo
        append: yes

    - name: Add .ssh directory
      file:
        path: "{{ home_directory }}/.ssh"
        state: "directory"
        mode: 0700
        owner: "{{ username }}"
        group: "{{ username }}"
      become: yes
      become_user: "{{ username }}"

    - name: Install the SSH private key used for working with repos.
      copy:
        content: "{{ private_ssh_key }}"
        dest: "{{ home_directory }}/.ssh/id_ed25519"
        mode: 0600
      become: yes
      become_user: "{{ username }}"

    - name: Install the SSH public key.
      copy:
        content: "{{ public_ssh_key }}"
        dest: "{{ home_directory }}/.ssh/id_ed25519.pub"
        mode: 0644
      become: yes
      become_user: "{{ username }}"

    - name: Copy .ssh/id_ed25519 from host box to the remote box for user {{ username }}
      become: yes
      copy: 
        src: ~/.ssh/id_ed25519.pub
        dest: "{{ home_directory }}/.ssh/authorized_keys"
        mode: 0600
        owner: "{{ username }}"
        group: "{{ username }}"
      tags:
        - copy_host_ssh_id

    - name: Add new user to sudoers list
      lineinfile:
        dest: /etc/sudoers
        regexp: "{{ username }} ALL"
        line: "{{ username }}	ALL=(ALL) 	NOPASSWD: ALL"
        state: present
  