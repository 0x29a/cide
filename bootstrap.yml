---
# Playbook for setting up everything.

- name: Set up CIDE.
  hosts: cide
  vars_files:
    - .vars.private.yml
  tasks:
    - name: Creating a user named {{ username }} on the specified web server.
      user: 
        name: "{{ username }}"
        password: "{{ user_password | password_hash('sha512') }}"
        state: present
        shell: /bin/bash
        groups: sudo
        append: yes
        generate_ssh_key: yes
        ssh_key_type: ed25519
        ssh_key_file: .ssh/id_ed25519

    - name: Copy .ssh/id_ed25519 from host box to the remote box for user {{ username }}
      become: true
      copy: 
        src: ~/.ssh/id_ed25519.pub
        dest: /home/{{ username }}/.ssh/authorized_keys
        mode: 0600
        owner: "{{ username }}"
        group: "{{ username }}"
      tags:
        - copy_host_ssh_id

    - name: Add new user to sudoers list
      lineinfile:
        dest: /etc/sudoers
        regexp: "{{ username }} ALL"
        line: "{{ username }}	ALL=(ALL) 	NOPASSWD: ALL"
        state: present
  